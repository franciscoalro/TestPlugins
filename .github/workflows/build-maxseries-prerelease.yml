name: Build MaxSeries Plugin (Pre-Release)

on:
  push:
    branches: [ master, main ]
    paths:
      - 'MaxSeries/**'
      - '.github/workflows/build-maxseries-prerelease.yml'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run with debug logging'
        required: false
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: wrapper
        
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build library module first
      run: |
        echo "ðŸ“¦ Building library module..."
        ./gradlew :library:build --no-daemon --stacktrace
      
    - name: Build MaxSeries plugin
      run: |
        echo "ðŸ”¨ Building MaxSeries plugin..."
        ./gradlew :MaxSeries:assembleRelease --no-daemon --stacktrace
      
    - name: List build outputs
      run: |
        echo "ðŸ“‹ Build outputs:"
        find MaxSeries/build -type f \( -name "*.aar" -o -name "*.jar" \) -exec ls -lh {} \;
      
    - name: Upload MaxSeries AAR
      uses: actions/upload-artifact@v4
      with:
        name: maxseries-v80-aar
        path: MaxSeries/build/outputs/**/*.aar
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload MaxSeries JAR
      uses: actions/upload-artifact@v4
      with:
        name: maxseries-v80-jar
        path: MaxSeries/build/libs/**/*.jar
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload all build outputs
      uses: actions/upload-artifact@v4
      with:
        name: maxseries-v80-all-outputs
        path: |
          MaxSeries/build/outputs/
          MaxSeries/build/libs/
        retention-days: 7
        if-no-files-found: warn
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          MaxSeries/build/outputs/**/*.aar
          MaxSeries/build/libs/**/*.jar
        draft: false
        prerelease: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build summary
      if: always()
      run: |
        echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### MaxSeries v80 - Cloudstream Pre-Release" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Outputs" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find MaxSeries/build -type f \( -name "*.aar" -o -name "*.jar" \) 2>/dev/null || echo "No outputs found"
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
