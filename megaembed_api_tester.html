<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>MegaEmbed API Flow Tester</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 1rem;
            background: #121212;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        h1 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .section {
            background: #1e1e1e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .section h2 {
            font-size: 1rem;
            margin: 0 0 .5rem 0;
            color: #2196F3;
        }

        input,
        button {
            padding: .5rem;
            border-radius: 4px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: #e0e0e0;
            margin-right: .5rem;
        }

        button {
            background: #2196F3;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #1976D2;
        }

        pre {
            background: #0a0a0a;
            padding: .5rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: .75rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .success {
            color: #66BB6A;
        }

        .error {
            color: #EF5350;
        }

        .pending {
            color: #FFA726;
        }

        #videoContainer {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            margin-top: 1rem;
        }

        video {
            width: 100%;
            height: 100%;
        }

        .step {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-bottom: .5rem;
        }

        .step-num {
            background: #2196F3;
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .75rem;
        }
    </style>
</head>

<body>
    <h1>üî¨ MegaEmbed API Flow Tester</h1>

    <div class="section">
        <h2>Configura√ß√£o</h2>
        <div style="margin-bottom:.5rem;">
            <label>Video ID: </label>
            <input id="videoId" value="3wnuij" style="width:120px;" />
            <label style="margin-left:1rem;">Referrer Domain: </label>
            <input id="refDomain" value="playerthree.online" style="width:180px;" />
        </div>
        <button id="runFlowBtn">‚ñ∂ Executar Fluxo Completo</button>
        <button id="clearBtn" style="background:#666;">üóë Limpar</button>
    </div>

    <div class="section">
        <h2>Fluxo de Requisi√ß√µes</h2>

        <div class="step">
            <span class="step-num">1</span>
            <span>/api/v1/info</span>
            <span id="step1Status" class="pending">‚è≥</span>
        </div>
        <pre id="step1Response">Aguardando...</pre>

        <div class="step">
            <span class="step-num">2</span>
            <span>/api/v1/video</span>
            <span id="step2Status" class="pending">‚è≥</span>
        </div>
        <pre id="step2Response">Aguardando...</pre>

        <div class="step">
            <span class="step-num">3</span>
            <span>/api/v1/player</span>
            <span id="step3Status" class="pending">‚è≥</span>
        </div>
        <pre id="step3Response">Aguardando...</pre>

        <div class="step">
            <span class="step-num">4</span>
            <span>Playlist HLS Final</span>
            <span id="step4Status" class="pending">‚è≥</span>
        </div>
        <pre id="step4Response">Aguardando...</pre>
    </div>

    <div class="section">
        <h2>üé¨ Player de Teste</h2>
        <div>
            <input id="playlistUrl" placeholder="URL da playlist ser√° preenchida automaticamente" style="width:80%;" />
            <button id="playBtn">‚ñ∂ Play</button>
        </div>
        <div id="videoContainer">
            <video id="video" controls></video>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const BASE_URL = 'https://megaembed.link';
        // CORS Proxy - necess√°rio para testes no navegador
        const CORS_PROXY = 'https://corsproxy.io/?';

        const videoIdInput = document.getElementById('videoId');
        const refDomainInput = document.getElementById('refDomain');
        const runFlowBtn = document.getElementById('runFlowBtn');
        const clearBtn = document.getElementById('clearBtn');
        const playlistUrlInput = document.getElementById('playlistUrl');
        const playBtn = document.getElementById('playBtn');
        const video = document.getElementById('video');

        function setStatus(step, status, isError = false) {
            const el = document.getElementById(`step${step}Status`);
            el.textContent = status;
            el.className = isError ? 'error' : 'success';
        }

        function setResponse(step, text) {
            document.getElementById(`step${step}Response`).textContent = text;
        }

        async function fetchWithProxy(url, headers = {}) {
            const proxyUrl = CORS_PROXY + encodeURIComponent(url);
            console.log('Fetching:', url);

            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    ...headers
                }
            });

            return {
                ok: response.ok,
                status: response.status,
                text: await response.text()
            };
        }

        function extractToken(response) {
            // Tentar JSON
            try {
                const json = JSON.parse(response);
                if (json.token) return json.token;
                if (json.t) return json.t;
                if (json.data && typeof json.data === 'string') return json.data;
                if (json.data && json.data.token) return json.data.token;
            } catch (e) { }

            // Token hexadecimal longo
            const match = response.match(/[a-f0-9]{100,}/i);
            if (match) return match[0];

            return null;
        }

        function extractPlaylistUrl(response) {
            // Padr√µes de URL
            const patterns = [
                /https?:\/\/[^"'\s]+\/v4\/[^"'\s]+\.txt/gi,
                /https?:\/\/[^"'\s]+\.m3u8[^"'\s]*/gi
            ];

            for (const pattern of patterns) {
                const match = response.match(pattern);
                if (match) return match[0].replace(/['"]/g, '');
            }

            // Tentar JSON
            try {
                const json = JSON.parse(response);
                for (const field of ['url', 'file', 'source', 'src', 'stream', 'playlist']) {
                    if (json[field] && json[field].startsWith('http')) return json[field];
                    if (json.data && json.data[field]) return json.data[field];
                }
            } catch (e) { }

            return null;
        }

        async function runFlow() {
            const videoId = videoIdInput.value.trim();
            const refDomain = refDomainInput.value.trim();

            if (!videoId) {
                alert('Informe o Video ID');
                return;
            }

            // Reset
            for (let i = 1; i <= 4; i++) {
                setStatus(i, '‚è≥');
                document.getElementById(`step${i}Status`).className = 'pending';
                setResponse(i, 'Aguardando...');
            }

            try {
                // === PASSO 1: /api/v1/info ===
                console.log('=== PASSO 1: /api/v1/info ===');
                const infoUrl = `${BASE_URL}/api/v1/info?id=${videoId}`;
                const infoResp = await fetchWithProxy(infoUrl);
                setResponse(1, `URL: ${infoUrl}\nStatus: ${infoResp.status}\n\nResponse:\n${infoResp.text}`);
                setStatus(1, infoResp.ok ? '‚úÖ' : '‚ùå', !infoResp.ok);

                // === PASSO 2: /api/v1/video ===
                console.log('=== PASSO 2: /api/v1/video ===');
                const videoUrl = `${BASE_URL}/api/v1/video?id=${videoId}&w=1920&h=1080&r=${refDomain}`;
                const videoResp = await fetchWithProxy(videoUrl);
                setResponse(2, `URL: ${videoUrl}\nStatus: ${videoResp.status}\n\nResponse:\n${videoResp.text}`);

                if (!videoResp.ok) {
                    setStatus(2, '‚ùå', true);
                    throw new Error('Falha no passo 2');
                }
                setStatus(2, '‚úÖ');

                // Extrair token
                const token = extractToken(videoResp.text);
                if (!token) {
                    setResponse(2, document.getElementById('step2Response').textContent + '\n\n‚ö†Ô∏è TOKEN N√ÉO ENCONTRADO');
                    throw new Error('Token n√£o encontrado');
                }
                setResponse(2, document.getElementById('step2Response').textContent + `\n\nüîë Token extra√≠do: ${token.substring(0, 50)}...`);

                // === PASSO 3: /api/v1/player ===
                console.log('=== PASSO 3: /api/v1/player ===');
                const playerUrl = `${BASE_URL}/api/v1/player?t=${token}`;
                const playerResp = await fetchWithProxy(playerUrl);
                setResponse(3, `URL: ${playerUrl.substring(0, 100)}...\nStatus: ${playerResp.status}\n\nResponse:\n${playerResp.text}`);

                if (!playerResp.ok) {
                    setStatus(3, '‚ùå', true);
                    throw new Error('Falha no passo 3');
                }
                setStatus(3, '‚úÖ');

                // Extrair playlist URL
                const playlist = extractPlaylistUrl(playerResp.text);
                if (!playlist) {
                    setResponse(3, document.getElementById('step3Response').textContent + '\n\n‚ö†Ô∏è PLAYLIST URL N√ÉO ENCONTRADA');
                    throw new Error('Playlist URL n√£o encontrada');
                }
                setResponse(3, document.getElementById('step3Response').textContent + `\n\nüé¨ Playlist: ${playlist}`);

                // === PASSO 4: Baixar Playlist ===
                console.log('=== PASSO 4: Playlist Final ===');
                const playlistResp = await fetchWithProxy(playlist);
                setResponse(4, `URL: ${playlist}\nStatus: ${playlistResp.status}\n\nResponse (primeiros 500 chars):\n${playlistResp.text.substring(0, 500)}`);

                if (!playlistResp.ok) {
                    setStatus(4, '‚ùå', true);
                } else if (playlistResp.text.includes('#EXTM3U')) {
                    setStatus(4, '‚úÖ HLS V√°lido!');
                    playlistUrlInput.value = playlist;
                } else {
                    setStatus(4, '‚ö†Ô∏è N√£o √© HLS');
                }

            } catch (error) {
                console.error('Erro no fluxo:', error);
            }
        }

        function playVideo() {
            const src = playlistUrlInput.value.trim();
            if (!src) {
                alert('URL da playlist vazia');
                return;
            }

            if (Hls.isSupported()) {
                const hls = new Hls({
                    xhrSetup: (xhr, url) => {
                        // Nota: no navegador, n√£o conseguimos setar Referer devido a CORS
                        // Mas no app Android (OkHttp), isso funciona perfeitamente
                    }
                });
                hls.loadSource(CORS_PROXY + encodeURIComponent(src));
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                hls.on(Hls.Events.ERROR, (e, d) => console.error('HLS Error:', d));
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = src;
                video.play();
            }
        }

        runFlowBtn.addEventListener('click', runFlow);
        clearBtn.addEventListener('click', () => {
            for (let i = 1; i <= 4; i++) {
                setStatus(i, '‚è≥');
                document.getElementById(`step${i}Status`).className = 'pending';
                setResponse(i, 'Aguardando...');
            }
            playlistUrlInput.value = '';
        });
        playBtn.addEventListener('click', playVideo);
    </script>
</body>

</html>